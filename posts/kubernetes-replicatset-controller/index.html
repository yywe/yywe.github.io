<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Kubernetes ReplicaSet Controller Design Principle" /><meta name="author" content="Hulua" /><meta property="og:locale" content="en" /><meta name="description" content="In kubernetes, controllers play a vital role to orchestrate resources. For beginners learning kubernetes, we need to understand what are controllers. In short, controllers manipulate resources. In particular, resources indicate a collection of static object definition, and they exist in the ETCD database (managed by ApiServer). For a simple example, you can throw the below pod yaml file 1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 into ETCD using kubectl, then you have a Pod resource. However, before scheduler arranges it to run in some node and kubelet starts the runtime container, the resource is just a static definition. This sounds like an order for a meal, it is just there and may not be cooked/served yet. The role of controllers is to orchestrate a lot of orders (but controllers do not cook or serve dishes). As another example, say if you throw a ReplicaSet with 3 replicas into ETCD, replicatset controller will then create 3 corresponding Pod resources in ETCD. Again they just make the order, the actual work to launch containers is the responsibility of kubelet. As such, you can immagine that controller development/debug does not require container runtime at all." /><meta property="og:description" content="In kubernetes, controllers play a vital role to orchestrate resources. For beginners learning kubernetes, we need to understand what are controllers. In short, controllers manipulate resources. In particular, resources indicate a collection of static object definition, and they exist in the ETCD database (managed by ApiServer). For a simple example, you can throw the below pod yaml file 1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 into ETCD using kubectl, then you have a Pod resource. However, before scheduler arranges it to run in some node and kubelet starts the runtime container, the resource is just a static definition. This sounds like an order for a meal, it is just there and may not be cooked/served yet. The role of controllers is to orchestrate a lot of orders (but controllers do not cook or serve dishes). As another example, say if you throw a ReplicaSet with 3 replicas into ETCD, replicatset controller will then create 3 corresponding Pod resources in ETCD. Again they just make the order, the actual work to launch containers is the responsibility of kubelet. As such, you can immagine that controller development/debug does not require container runtime at all." /><link rel="canonical" href="https://yywe.github.io/posts/kubernetes-replicatset-controller/" /><meta property="og:url" content="https://yywe.github.io/posts/kubernetes-replicatset-controller/" /><meta property="og:site_name" content="Hulua" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-27T08:55:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kubernetes ReplicaSet Controller Design Principle" /><meta name="twitter:site" content="@Hulua" /><meta name="twitter:creator" content="@Hulua" /><meta name="google-site-verification" content="liMLPEFk1OeBj60sNB4ZWXljAWSaM_5PT6cFO3qH-kg" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Hulua"},"description":"In kubernetes, controllers play a vital role to orchestrate resources. For beginners learning kubernetes, we need to understand what are controllers. In short, controllers manipulate resources. In particular, resources indicate a collection of static object definition, and they exist in the ETCD database (managed by ApiServer). For a simple example, you can throw the below pod yaml file 1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Pod metadata: name: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 into ETCD using kubectl, then you have a Pod resource. However, before scheduler arranges it to run in some node and kubelet starts the runtime container, the resource is just a static definition. This sounds like an order for a meal, it is just there and may not be cooked/served yet. The role of controllers is to orchestrate a lot of orders (but controllers do not cook or serve dishes). As another example, say if you throw a ReplicaSet with 3 replicas into ETCD, replicatset controller will then create 3 corresponding Pod resources in ETCD. Again they just make the order, the actual work to launch containers is the responsibility of kubelet. As such, you can immagine that controller development/debug does not require container runtime at all.","headline":"Kubernetes ReplicaSet Controller Design Principle","dateModified":"2023-08-04T20:45:52-04:00","url":"https://yywe.github.io/posts/kubernetes-replicatset-controller/","datePublished":"2022-04-27T08:55:00-04:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://yywe.github.io/posts/kubernetes-replicatset-controller/"},"@context":"https://schema.org"}</script><title>Kubernetes ReplicaSet Controller Design Principle | Hulua</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Hulua"><meta name="application-name" content="Hulua"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/favicon.ico" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Hulua</a></div><div class="site-subtitle font-italic">Welcome to my home page</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/yywe" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Hulua" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['stweiyy','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Kubernetes ReplicaSet Controller Design Principle</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kubernetes ReplicaSet Controller Design Principle</h1><div class="post-meta text-muted"><div> By <em> Hulua </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1651064100" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-27 </em> </span> <span> Updated <em class="timeago" data-ts="1691196352" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2023-08-04 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1558 words"> <em>8 min</em> read</span> <span> read by <em id="mypv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </em> visitor </span> <span><i class="far fa-thumbs-up fa-fw" id="thumbsupbtn" ></i> <span><em id="postskubernetesreplicatsetcontroller" class="num_of_likes"></em></span> </span></div></div></div><div class="post-content"><p>In kubernetes, controllers play a vital role to orchestrate resources. For beginners learning kubernetes, we need to understand what are controllers. In short, controllers manipulate resources. In particular, resources indicate a collection of static object definition, and they exist in the ETCD database (managed by ApiServer). For a simple example, you can throw the below pod yaml file</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.14.2</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
</pre></table></code></div></div><p>into ETCD using kubectl, then you have a Pod resource. However, before scheduler arranges it to run in some node and kubelet starts the runtime container, the resource is just a static definition. This sounds like an order for a meal, it is just there and may not be cooked/served yet. The role of controllers is to orchestrate a lot of orders (but controllers do not cook or serve dishes). As another example, say if you throw a ReplicaSet with 3 replicas into ETCD, replicatset controller will then create 3 corresponding Pod resources in ETCD. Again they just make the order, the actual work to launch containers is the responsibility of kubelet. As such, you can immagine that controller development/debug does not require container runtime at all.</p><p>ReplicaSet controller in k8s is a very basic controller. In this post, we will have a look at the implementation details for ReplicatSet controller.</p><h1 id="run-replicatset-controller">Run ReplicatSet Controller</h1><p>Earlier I shared a post on how to debug k8s source code. However, that solution is too cubersome. In fact, we have a lighter way if we just want to run/debug simple function unit. Let’s go the the k8s source code folder and run:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="go">kubernetes git:(master) go test -v ./pkg/controller/replicaset -run TestWatchPods
=== RUN   TestWatchPods
I0427 10:34:13.498307   65353 replica_set.go:205] Starting replicaset controller
I0427 10:34:13.498605   65353 shared_informer.go:255] Waiting for caches to sync for ReplicaSet
I0427 10:34:13.498619   65353 shared_informer.go:262] Caches are synced for ReplicaSet
--- PASS: TestWatchPods (0.00s)
PASS
ok  	k8s.io/kubernetes/pkg/controller/replicaset	0.789s
</span></pre></table></code></div></div><p>Now, you see we started a replicaset controller and did a test. The details of this test can be found <code class="language-plaintext highlighter-rouge">./pkg/controller/replicaset/replicat_set_test.go</code>. You can also do a step-by-step debug using:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="go">➜  kubernetes git:(master) dlv test ./pkg/controller/replicaset/

Type 'help' for list of commands.
(dlv) b TestWatchPods
Breakpoint 1 set at 0x2afd2d2 for k8s.io/kubernetes/pkg/controller/replicaset.TestWatchPods() ./pkg/controller/replicaset/replica_set_test.go:708
(dlv) c
</span><span class="gp">=&gt;</span><span class="w"> </span>708:	func TestWatchPods<span class="o">(</span>t <span class="k">*</span>testing.T<span class="o">)</span> <span class="o">{</span>
<span class="go">   709:		client := fake.NewSimpleClientset()
   710:
   711:		fakeWatch := watch.NewFake()
   712:		client.PrependWatchReactor("pods", core.DefaultWatchReactor(fakeWatch, nil))
</span></pre></table></code></div></div><p>Then you will be able to go through the steps of creating the controller and see how it works.</p><h1 id="replicaset-controller-design-principle">ReplicaSet Controller Design Principle</h1><p>The ultimate goal of replicat set controller is to ensure there are always a dedicated number of pods (here we can only ensure from the resource manifest level, but we cannot guarantee cooresponding containers can be created). Before we have look at the implementation, it is helpful if we ask the following questions:</p><p><em>How to deal with the case when controllers get restarted?</em></p><p>Cause the controllers may be interrupted but the number of pods is not enough. The overview is count the existing number of pods <em>at the begining of every sync</em> loop. Each managed pod is expected to have the same labels and may have a owner reference points to the replicat set. Then depending on the number, we keep creating or deleting pods to statisfy the dedidated number.</p><h1 id="implementation-details">Implementation Details</h1><p>We will take a look at a few key implementation details. The ReplicatSetController is defined as a struct:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">ReplicaSetController</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">schema</span><span class="o">.</span><span class="n">GroupVersionKind</span>
	<span class="n">kubeClient</span> <span class="n">clientset</span><span class="o">.</span><span class="n">Interface</span>
	
    <span class="c">//This is podController interface, which will be responsible to create or delete pod </span>
    <span class="c">//resources.</span>
	<span class="n">podControl</span> <span class="n">controller</span><span class="o">.</span><span class="n">PodControlInterface</span>
	
	<span class="n">burstReplicas</span> <span class="kt">int</span>
	<span class="n">syncHandler</span> <span class="k">func</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">rsKey</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>

	<span class="c">// Think about what if we want to create 200 Pods in one sync, but before it finishes</span>
	<span class="c">// a second sync is started? Here in the first sync, expecations will say I expect to </span>
	<span class="c">// create 200 pods. Thus if the expections are not satisfied, second sync  will quit</span>
	<span class="n">expectations</span> <span class="o">*</span><span class="n">controller</span><span class="o">.</span><span class="n">UIDTrackingControllerExpectations</span>


	<span class="n">rsLister</span> <span class="n">appslisters</span><span class="o">.</span><span class="n">ReplicaSetLister</span>
	<span class="n">rsListerSynced</span> <span class="n">cache</span><span class="o">.</span><span class="n">InformerSynced</span>
	
    <span class="c">//This is storage for objects</span>
	<span class="n">rsIndexer</span>      <span class="n">cache</span><span class="o">.</span><span class="n">Indexer</span>


	<span class="n">podLister</span> <span class="n">corelisters</span><span class="o">.</span><span class="n">PodLister</span>
	
	<span class="n">podListerSynced</span> <span class="n">cache</span><span class="o">.</span><span class="n">InformerSynced</span>

	<span class="c">// This is work queue. items in this queue will be processed one by one</span>
	<span class="n">queue</span> <span class="n">workqueue</span><span class="o">.</span><span class="n">RateLimitingInterface</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When the ReplicatSet controller is created, it will listen to Replicat Set and Pods Add/Update/Delete Events.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">NewBaseController</span><span class="p">(</span><span class="n">rsInformer</span> <span class="n">appsinformers</span><span class="o">.</span><span class="n">ReplicaSetInformer</span><span class="p">,</span> <span class="n">podInformer</span> <span class="n">coreinformers</span><span class="o">.</span><span class="n">PodInformer</span><span class="p">,</span> <span class="n">kubeClient</span> <span class="n">clientset</span><span class="o">.</span><span class="n">Interface</span><span class="p">,</span> <span class="n">burstReplicas</span> <span class="kt">int</span><span class="p">,</span>
	<span class="n">gvk</span> <span class="n">schema</span><span class="o">.</span><span class="n">GroupVersionKind</span><span class="p">,</span> <span class="n">metricOwnerName</span><span class="p">,</span> <span class="n">queueName</span> <span class="kt">string</span><span class="p">,</span> <span class="n">podControl</span> <span class="n">controller</span><span class="o">.</span><span class="n">PodControlInterface</span><span class="p">)</span> <span class="o">*</span><span class="n">ReplicaSetController</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">kubeClient</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">kubeClient</span><span class="o">.</span><span class="n">CoreV1</span><span class="p">()</span><span class="o">.</span><span class="n">RESTClient</span><span class="p">()</span><span class="o">.</span><span class="n">GetRateLimiter</span><span class="p">()</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">ratelimiter</span><span class="o">.</span><span class="n">RegisterMetricAndTrackRateLimiterUsage</span><span class="p">(</span><span class="n">metricOwnerName</span><span class="p">,</span> <span class="n">kubeClient</span><span class="o">.</span><span class="n">CoreV1</span><span class="p">()</span><span class="o">.</span><span class="n">RESTClient</span><span class="p">()</span><span class="o">.</span><span class="n">GetRateLimiter</span><span class="p">())</span>
	<span class="p">}</span>

    <span class="o">...</span>
	<span class="n">rsInformer</span><span class="o">.</span><span class="n">Informer</span><span class="p">()</span><span class="o">.</span><span class="n">AddEventHandler</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ResourceEventHandlerFuncs</span><span class="p">{</span>
		<span class="n">AddFunc</span><span class="o">:</span>    <span class="n">rsc</span><span class="o">.</span><span class="n">addRS</span><span class="p">,</span>
		<span class="n">UpdateFunc</span><span class="o">:</span> <span class="n">rsc</span><span class="o">.</span><span class="n">updateRS</span><span class="p">,</span>
		<span class="n">DeleteFunc</span><span class="o">:</span> <span class="n">rsc</span><span class="o">.</span><span class="n">deleteRS</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="o">...</span>
		<span class="n">podInformer</span><span class="o">.</span><span class="n">Informer</span><span class="p">()</span><span class="o">.</span><span class="n">AddEventHandler</span><span class="p">(</span><span class="n">cache</span><span class="o">.</span><span class="n">ResourceEventHandlerFuncs</span><span class="p">{</span>
		<span class="n">AddFunc</span><span class="o">:</span> <span class="n">rsc</span><span class="o">.</span><span class="n">addPod</span><span class="p">,</span>
		<span class="c">// This invokes the ReplicaSet for every pod change, eg: host assignment. Though this might seem like</span>
		<span class="c">// overkill the most frequent pod update is status, and the associated ReplicaSet will only list from</span>
		<span class="c">// local storage, so it should be ok.</span>
		<span class="n">UpdateFunc</span><span class="o">:</span> <span class="n">rsc</span><span class="o">.</span><span class="n">updatePod</span><span class="p">,</span>
		<span class="n">DeleteFunc</span><span class="o">:</span> <span class="n">rsc</span><span class="o">.</span><span class="n">deletePod</span><span class="p">,</span>
	<span class="p">})</span>
</pre></table></code></div></div><p>For which ever detected, the corresponding action is to add the respective ReplicatSet resource into the work queue. For instance:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">*</span><span class="n">ReplicaSetController</span><span class="p">)</span> <span class="n">addRS</span><span class="p">(</span><span class="n">obj</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="n">rs</span> <span class="o">:=</span> <span class="n">obj</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">apps</span><span class="o">.</span><span class="n">ReplicaSet</span><span class="p">)</span>
	<span class="n">klog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="o">.</span><span class="n">Infof</span><span class="p">(</span><span class="s">"Adding %s %s/%s"</span><span class="p">,</span> <span class="n">rsc</span><span class="o">.</span><span class="n">Kind</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
	<span class="n">rsc</span><span class="o">.</span><span class="n">enqueueRS</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">func</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">*</span><span class="n">ReplicaSetController</span><span class="p">)</span> <span class="n">enqueueRS</span><span class="p">(</span><span class="n">rs</span> <span class="o">*</span><span class="n">apps</span><span class="o">.</span><span class="n">ReplicaSet</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">key</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">controller</span><span class="o">.</span><span class="n">KeyFunc</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">utilruntime</span><span class="o">.</span><span class="n">HandleError</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"couldn't get key for object %#v: %v"</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="n">rsc</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now we can have a look at the control loop. For each worker process, it will take one item from the work queue and call <code class="language-plaintext highlighter-rouge">syncHandler</code> to start a sync loop.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">*</span><span class="n">ReplicaSetController</span><span class="p">)</span> <span class="n">processNextWorkItem</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="n">key</span><span class="p">,</span> <span class="n">quit</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">quit</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">rsc</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">Done</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

	<span class="n">err</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">syncHandler</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">rsc</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">Forget</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>

	<span class="n">utilruntime</span><span class="o">.</span><span class="n">HandleError</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"sync %q failed with %v"</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
	<span class="n">rsc</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">AddRateLimited</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

	<span class="k">return</span> <span class="no">true</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Here <code class="language-plaintext highlighter-rouge">syncHandler</code> points to <code class="language-plaintext highlighter-rouge">syncReplicaSet</code>:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c">//Sync a specific replicat set, key is the fullname for the replicatset</span>
<span class="k">func</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">*</span><span class="n">ReplicaSetController</span><span class="p">)</span> <span class="n">syncReplicaSet</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="o">...</span>
    <span class="c">// Get namespace and anme</span>
	<span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cache</span><span class="o">.</span><span class="n">SplitMetaNamespaceKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    
    <span class="c">// Get the replicatset object</span>
	<span class="n">rs</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">rsLister</span><span class="o">.</span><span class="n">ReplicaSets</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c">// Check if the last round of sync is satisfied (finished)</span>
	<span class="n">rsNeedsSync</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">expectations</span><span class="o">.</span><span class="n">SatisfiedExpectations</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
	
    <span class="c">// First get all the pods in that namespace</span>
	<span class="n">allPods</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">podLister</span><span class="o">.</span><span class="n">Pods</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">Everything</span><span class="p">())</span>


	<span class="c">// Ignore inactive pods.</span>
	<span class="n">filteredPods</span> <span class="o">:=</span> <span class="n">controller</span><span class="o">.</span><span class="n">FilterActivePods</span><span class="p">(</span><span class="n">allPods</span><span class="p">)</span>


    <span class="c">// Now get all existing pods for the replicatset</span>
	<span class="n">filteredPods</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">claimPods</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">filteredPods</span><span class="p">)</span>

	<span class="k">var</span> <span class="n">manageReplicasErr</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="n">rsNeedsSync</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">.</span><span class="n">DeletionTimestamp</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
	
        <span class="c">// Now we depends on how many existing pods</span>
        <span class="c">// either create new pods or delete pods</span>
		<span class="n">manageReplicasErr</span> <span class="o">=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">manageReplicas</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">filteredPods</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="o">....</span>
</pre></table></code></div></div><p>The actual work to create new pods or delete pods will be done in <code class="language-plaintext highlighter-rouge">manageReplicas</code>.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">*</span><span class="n">ReplicaSetController</span><span class="p">)</span> <span class="n">manageReplicas</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">filteredPods</span> <span class="p">[]</span><span class="o">*</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">,</span> <span class="n">rs</span> <span class="o">*</span><span class="n">apps</span><span class="o">.</span><span class="n">ReplicaSet</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

    <span class="c">//Caclulate the difference, either to create a delete</span>
	<span class="n">diff</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filteredPods</span><span class="p">)</span> <span class="o">-</span> <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span><span class="p">))</span>
	<span class="n">rsKey</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">controller</span><span class="o">.</span><span class="n">KeyFunc</span><span class="p">(</span><span class="n">rs</span><span class="p">)</span>
	<span class="o">...</span>
	<span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">*=</span> <span class="o">-</span><span class="m">1</span>
		<span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="n">rsc</span><span class="o">.</span><span class="n">burstReplicas</span> <span class="p">{</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">burstReplicas</span>
		<span class="p">}</span>
		<span class="c">// Set the number of pods expected to create, for each pod </span>
		<span class="c">// that is created succefully, this number will decrease 1.</span>
		<span class="c">// When pod add event is detected, there is a call to </span>
		<span class="c">// rsc.expectations.CreationObserved(rsKey) to reduce this number</span>
		<span class="c">// The next round of sync will quit if this number is not 0.</span>
		<span class="n">rsc</span><span class="o">.</span><span class="n">expectations</span><span class="o">.</span><span class="n">ExpectCreations</span><span class="p">(</span><span class="n">rsKey</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
		<span class="n">klog</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">.</span><span class="n">InfoS</span><span class="p">(</span><span class="s">"Too few replicas"</span><span class="p">,</span> <span class="s">"replicaSet"</span><span class="p">,</span> <span class="n">klog</span><span class="o">.</span><span class="n">KObj</span><span class="p">(</span><span class="n">rs</span><span class="p">),</span> <span class="s">"need"</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Replicas</span><span class="p">),</span> <span class="s">"creating"</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
		

		<span class="n">successfulCreations</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">slowStartBatch</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">controller</span><span class="o">.</span><span class="n">SlowStartInitialBatchSize</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
		    <span class="c">// Actual create pods work is delegated to podControl</span>
			<span class="n">err</span> <span class="o">:=</span> <span class="n">rsc</span><span class="o">.</span><span class="n">podControl</span><span class="o">.</span><span class="n">CreatePods</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rs</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="o">.</span><span class="n">Spec</span><span class="o">.</span><span class="n">Template</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">metav1</span><span class="o">.</span><span class="n">NewControllerRef</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rsc</span><span class="o">.</span><span class="n">GroupVersionKind</span><span class="p">))</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="k">if</span> <span class="n">apierrors</span><span class="o">.</span><span class="n">HasStatusCause</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">v1</span><span class="o">.</span><span class="n">NamespaceTerminatingCause</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="no">nil</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">})</span>
        <span class="o">....</span>
	<span class="p">}</span>
</pre></table></code></div></div><p>Actual pods creation work is wrapped in <code class="language-plaintext highlighter-rouge">slowStartBatch</code>, there pods will be created batch by batch with different batch sizes.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>        <span class="n">errCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="n">batchSize</span><span class="p">)</span>
		<span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>
		<span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">batchSize</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">batchSize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
				<span class="c">//Here fn is the function passed from the parameter of slowStartBatch</span>
				<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">fn</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
					<span class="n">errCh</span> <span class="o">&lt;-</span> <span class="n">err</span>
				<span class="p">}</span>
			<span class="p">}()</span>
		<span class="p">}</span>
		<span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
</pre></table></code></div></div><h1 id="summary">Summary</h1><p>In this post, we had an overview of the principle of replicat set controller in k8s. At each sync loop, the controller will claim pods (i.e., count how many pods exists under the replicat set), then decide whether to create more pods or delete pods. There are some hightlight implementation tricks to pay attention, such as use expectations to avoid concurrent sync loop, and use slow start batch to make pod creation process smooth.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/source-code/'>Source Code</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/debug/" class="post-tag no-text-decoration" >debug</a> <a href="/tags/source-code/" class="post-tag no-text-decoration" >source code</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kubernetes+ReplicaSet+Controller+Design+Principle+-+Hulua&url=https%3A%2F%2Fyywe.github.io%2Fposts%2Fkubernetes-replicatset-controller%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kubernetes+ReplicaSet+Controller+Design+Principle+-+Hulua&u=https%3A%2F%2Fyywe.github.io%2Fposts%2Fkubernetes-replicatset-controller%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fyywe.github.io%2Fposts%2Fkubernetes-replicatset-controller%2F&text=Kubernetes+ReplicaSet+Controller+Design+Principle+-+Hulua" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div><script> $(function () { /*Get likes count*/ /*Only one element meet the condition thus safe to do so*/ var elemID = null; $(".num_of_likes").map(function () { elemID = $(this).attr("id") }); $.ajax({ url: 'https://my-api-service-344803.uc.r.appspot.com/apis/data/countlikes', type: 'GET', data: { "pids": [elemID] }, traditional: true, success: function (data) { $.each(data, function (key, val) { $('#' + key).text(val) }) }, error: function (xhr, textStatus) { console.log('error in ajax'); console.log(xhr); console.log(textStatus); } }); /*Get page visit count*/ var pageUrl = "/posts/kubernetes-replicatset-controller/"; $.ajax({ url: 'https://my-api-service-344803.uc.r.appspot.com/apis/pageviews', type: 'GET', data: { "path": pageUrl}, dataType: "json", success: function (data) { /*Due to history reason, url upper/lower case are different { "/posts/Go-Concurrency-Stop-Signal-And-Timeout/": 12, "/posts/go-concurrency-stop-signal-and-timeout/": 7 }, thus here justify*/ $.each(data, function (key, val) { if (key === pageUrl) { $('#mypv').text(val) } }) }, error: function (xhr, textStatus) { console.log('error in ajax'); console.log(xhr); console.log(textStatus); } }); /*Get IP address*/ var ipAddr = null; $.getJSON('https://api.db-ip.com/v2/free/self', function (data) { /* console.log(JSON.stringify(data, null, 2)); */ ipAddr = data.ipAddress }); /*Bind like button with click event*/ $('#thumbsupbtn').click(function () { if (ipAddr !== null && elemID !== null) { $.ajax({ url: 'https://my-api-service-344803.uc.r.appspot.com/apis/data/likeaction', type: 'POST', dataType: "json", contentType: "application/json; charset=utf-8", data: JSON.stringify({ "pid": elemID, "ip": ipAddr}), traditional: true, success: function (data) { $('#'+elemID).text(data.likenumber) }, error: function (xhr, textStatus) { console.log('error in ajax'); console.log(xhr); console.log(textStatus); } }) } }); }); </script></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/go-concurrency-write-concurrent-programs/">Go Concurrency - Write Concurrent Programs</a><li><a href="/posts/kubernetes-replicatset-controller/">Kubernetes ReplicaSet Controller Design Principle</a><li><a href="/posts/how-to-traverse-trees-in-rust/">How to Traverse Trees in Rust</a><li><a href="/posts/how-to-persist-your-ssh-session-in-remote-server/">How to Persist Your SSH Session in Remote Server</a><li><a href="/posts/a-better-way-to-debug-tidb-source-code/">A Better Way to Debug TiDB Source Code</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/debug/">debug</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/goroutine/">goroutine</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/source-code/">source code</a> <a class="post-tag" href="/tags/development-environment/">development environment</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/tidb/">TiDB</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/how-to-debug-k8s-sourceCode/"><div class="card-body"> <em class="timeago small" data-ts="1648817700" > 2022-04-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to Debug Kubernetes Source Code?</h3><div class="text-muted small"><p> Reading the source code of kubernetes is a great way to learn the internals of kubernetes. In this post, we will explore how to use debugger (dlv) to track the source code execution flow. Prerequi...</p></div></div></a></div><div class="card"> <a href="/posts/a-better-way-to-debug-tidb-source-code/"><div class="card-body"> <em class="timeago small" data-ts="1649422500" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Better Way to Debug TiDB Source Code</h3><div class="text-muted small"><p> TiDB is an interesting SQL database written in Golang. One major difference compared with popular exsiting relational databases is that in TiDB storage is separated as an independant runtime. The d...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-persist-your-ssh-session-in-remote-server/"><div class="card-body"> <em class="timeago small" data-ts="1690635300" > 2023-07-29 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to Persist Your SSH Session in Remote Server</h3><div class="text-muted small"><p> One of the major advatanage of developing server side applications in your local enviornment is that the terminal session never gets disconnected. The session is always available. 1 2 3 4 5 6 7 8 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/a-better-way-to-debug-tidb-source-code/" class="btn btn-outline-primary" prompt="Older"><p>A Better Way to Debug TiDB Source Code</p></a> <a href="/posts/how-to-traverse-trees-in-rust/" class="btn btn-outline-primary" prompt="Newer"><p>How to Traverse Trees in Rust</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://yywe.github.io/posts/kubernetes-replicatset-controller/'; this.page.identifier = '/posts/kubernetes-replicatset-controller/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://hulua-tech-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> <span>Welcome, the site has been visited <em id="my_pv_from_google" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </em> times.</p><p class="mb-0"> © 2023 <a href="https://twitter.com/#">Hulua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer><script> $(function () { /*Get approximate page visit count using path */ pageUrlroot = "/"; $.ajax({ url: 'https://my-api-service-344803.uc.r.appspot.com/apis/pageviews', type: 'GET', data: { "path": "/"}, dataType: "json", success: function (data) { $.each(data, function (key, val) { if (key === pageUrlroot) { $('#my_pv_from_google').text(val) } }) }, error: function (xhr, textStatus) { console.log('error in ajax'); console.log(xhr); console.log(textStatus); } }); }); </script></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/debug/">debug</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/goroutine/">goroutine</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/source-code/">source code</a> <a class="post-tag" href="/tags/development-environment/">development environment</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/rust/">rust</a> <a class="post-tag" href="/tags/tidb/">TiDB</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SL395S6583"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SL395S6583'); }); </script>
